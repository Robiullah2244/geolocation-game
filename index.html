<head>
    <style type="text/css">
        #pac-input {
            background-color: #fff;
            font-family: Roboto;
            font-size: 14px;
            font-weight: 350;
            margin-left: auto;
            padding: 0 11px 0 13px;
            text-overflow: ellipsis;
            width: 400px;
            height: 28px;
        }

        #pac-input:focus {
            border-color: #4d90fe;
        }

        input[type=number] {
            width: 220px;
        }

        input[type=text] {
            width: 220px;
        }

        #map {
            height: calc(100% - 120px);
        }
    </style>
    <title>Geolocation Game</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
    <div class="box-body content">
        <div class="col-md-12">
            <div>
                <h3>Geolocation Game</h3>
                <span>Enter a city</span>
                <input id="pac-input" type="text" placeholder="Search Box" />
                <span id="enteredCityId"></span>
                <br><br>
            </div>
            <div id="map"></div>
            <img id="current-location-icon" src="https://icon-library.com/images/position-icon/position-icon-19.jpg"
                style="width: 40px; cursor:pointer; background-color:white; margin-right:10px"
                title="Tap to get current location" />
        </div>
    </div>

    <script type="text/javascript">
        function initMap() {
            var enteredCity = {
                lat: null,
                lng: null
            };
            var markers = [];
            var currentLocationMarker = [];
            var yourLat = 45.4642, yourLng = 9.1900;
            // Map options
            var options = {
                zoom: 12,
                gestureHandling: 'greedy',
                center: { lat: yourLat, lng: yourLng },
                mapTypeId: 'satellite'
            }

            // New map
            var map = new google.maps.Map(document.getElementById('map'), options);
            var geocoder = new google.maps.Geocoder();

            var customStyled = [
                {
                    featureType: "all",
                    // elementType: "labels",
                    stylers: [
                        { visibility: "off" }
                    ]
                }
            ];
            map.set('styles', customStyled);

            // locateCurrentLocation();

            //Current Location Icon setup
            var currentLocation = document.getElementById('current-location-icon');
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(currentLocation);
            $('#current-location-icon').click(function () {
                locateCurrentLocation();
            })

            //Locate Your Location Start Here
            ///----------------------------------------
            function locateCurrentLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        var optionsForCurrentLocation = {
                            zoom: 16,
                            center: currentPosition,
                            animation: google.maps.Animation.BOUNCE,
                        }
                        map.setOptions(optionsForCurrentLocation);
                    },
                    function () {
                        alert('Error: The Geolocation service failed. Give location access from address bar to get current location');
                    });
                }
            }
            //Locate Your Location End Here
            ///----------------------------------------


            ///Search option Section Start here----------------
            ///----------------------------------------
            // Create the search box and link it to the UI element.
            var input = document.getElementById('pac-input');
            // var searchBox = new google.maps.places.SearchBox(input, {
            var autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['(cities)'], // Search result limit added only for cities
            });

            // Bind the map's bounds (viewport) property to the autocomplete object,
            // so that the autocomplete requests use the current map bounds for the
            // bounds option in the request.
            autocomplete.bindTo("bounds", map);

            // Listen for the event fired when the user selects a prediction and retrieve
            // more details for that place.
            autocomplete.addListener('place_changed', function () {
                removeMarkers()
                var place = autocomplete.getPlace();

                if (!place.geometry) {
                    console.log("Returned place contains no geometry");
                    return;
                }

                var myLat = place.geometry.location.lat();
                var myLng = place.geometry.location.lng();

                enteredCity = {
                    lat: myLat,
                    lng: myLng
                }
                document.getElementById('enteredCityId').innerHTML = `<br/><br/>Your entered city: <b>${place.formatted_address}</b>`;
            });
            ///Search option Section End here----------------
            ///----------------------------------------


            ///Calculate distance Section Start here----------------
            ///----------------------------------------
            function calculateDistance(destination) {
                var distanceService = new google.maps.DistanceMatrixService();
                var location = new google.maps.LatLng(enteredCity.lat, enteredCity.lng);
                distanceService.getDistanceMatrix(
                    {
                        origins: [location],
                        destinations: [destination],
                        travelMode: google.maps.TravelMode.WALKING,
                        unitSystem: google.maps.UnitSystem.IMPERIAL,
                        avoidHighways: false,
                        avoidTolls: false,
                    }, callBackDistanceService
                )
            }

            function callBackDistanceService(response, status) {
                if (status != google.maps.DistanceMatrixStatus.OK) {
                    return "Failed to fetch"
                }
                else {
                    console.log('response distance: ', response)
                    Swal.fire(`Distance between previously entered city and the point selected is ${response.rows[0].elements[0].distance.text}les`, '', 'warning')
                }
            }
            ///Calculate distance Section End here----------------
            ///----------------------------------------


            // Listen for click on map Start here----------------
            ///----------------------------------------

            google.maps.event.addListener(map, 'click', function (event) {
                if (enteredCity.lat == null || enteredCity.lng == null) {
                    return Swal.fire('Please enter a city first!', '', 'warning')
                }
                var myLat = event.latLng.lat();
                var myLng = event.latLng.lng();
                calculateDistance({ lat: myLat, lng: myLng })

                ///Retrieving location and set a marker with location name
                geocoder.geocode(
                    {
                        'latLng': event.latLng
                    },
                    function (results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {
                            if (results[0]) {
                                addMarker({
                                    coords: event.latLng,
                                    content: results[0].formatted_address
                                });
                            }
                        }
                    });

            });

            // Listen for click on map End here----------------
            ///----------------------------------------

            removeMarkers = () => {
                markers.forEach(function (marker) {
                    marker.setMap(null);
                });
            }

            function addMarker(props) {
                // Clear out the old markers.
                removeMarkers()
                markers = [];

                markers.push(new google.maps.Marker({
                    position: props.coords,
                    map: map,
                    draggable: true,
                    // animation: google.maps.Animation.DROP,
                    //   icon:'/contents/images/Home_Icon_30x39.png',
                }));


                // Check content
                if (props.content) {
                    var infoWindow = new google.maps.InfoWindow({
                        content: props.content
                    });

                    infoWindow.open(map, markers[0]);
                }

                google.maps.event.addListener(markers[0], 'click', function () {
                    infoWindow.open(map, markers[0]);
                })

                // Listen for dragend on marker
                google.maps.event.addListener(markers[0], 'dragend', function (event) {
                    var myLat = event.latLng.lat();
                    var myLng = event.latLng.lng();

                    ///Retrieving location
                    geocoder.geocode(
                        {
                            'latLng': event.latLng
                        },
                        function (results, status) {
                            if (status == google.maps.GeocoderStatus.OK) {
                                if (results[0]) {
                                    addMarker({
                                        coords: event.latLng,
                                        content: results[0].formatted_address

                                    });
                                }
                            }
                        });

                });
            }
        }

    </script>

    <script defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFoY1ZlI4XPujxob2EdQMpxANh1jsABuY&libraries=places&callback=initMap">
        </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.all.min.js"></script>
</body>